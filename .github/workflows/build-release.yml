name: Build & Push

on:
  release:
    types: [edited, published, ]

jobs:
  build-release:
    runs-on: ubuntu-latest
    steps:
    - id: checkout
      name: "Checkout"
      uses: actions/checkout@v2
    - id: version
      name: Get Version
      run: |
        pip3 install -r ./scripts/requirements.txt -q --no-input
        ./scripts/version-bump
    - name: "Build and push Docker images"
      uses: docker/build-push-action@v2.2.1
      with:
        push: true
        tags: |
          ionlights/ztdns:latest
          ionlights/ztdns:${{ github.ref }}
        build-args: |
          BUILD_DATE=$(date)
          ZeroDNS=${{ github.ref }}
          CoreDNS=${{ steps.bump.outputs.vCoreDNS }}
          CoreDNSpkg=${{ steps.outputs.bump.CoreDNSpkg }}
